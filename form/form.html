<link rel="stylesheet" href="form/form.css">
<form method="post" action="#" onchange="raw()" id="orderForm">
        <h3><span class="required">*</span> What Username Will You Use? (required)</h3>
         - used internally for submitting orders, and requesting results<br>
        <input
          type="text"
          name="username"
          id="username"
          value=""
          placeholder="Username"
          autocomplete="off"
          required />

        <h3><span class="required">*</span> How do I Contact You? (select at least one)</h3>
        - assume no voice calls, text communications only
          <div class="contact-row">
            <label for="discord">Discord:</label>
            <input type="text" name="discord" id="discord" value="" placeholder="username#1234" autocomplete="off">
          </div>

          <div class="contact-row">
            <label for="tel">Phone:</label>
            <input type="text" name="tel" id="tel" value="" placeholder="123-456-7890" autocomplete="off">
          </div>

          <div class="contact-row">
            <label for="email">Email:</label>
            <input type="text" name="email" id="email" value="" placeholder="email@example.com" autocomplete="off">
          </div>


        <br />

        <h3><span class="required">*</span> What Service Are You Requesting? (required)</h3>

<!-- Service Selection Dropdown -->
<div class="service-selection">
  <div class="select-wrapper">
    <select id="service-dropdown" name="services" required>
      <option value="" selected disabled>-- Select a service --</option>
      <option value="3d_prints">3D Prints</option>
      <option value="vtuber_models">Vtuber Models</option>
      <option value="discord_bot">Discord Bot</option>
      <option value="code_help">Code Help</option>
      <option value="other">Other</option>
    </select>
  </div>
  <div class="service-selection-note">Please select a service from the dropdown to continue</div>
</div>
<br>
<!-- Content will load here -->
<div id="dynamic-content"></div>

<script>
// No need to get a select element as we're using radio buttons

function raw() {
  // Get values from form fields
  var username = document.getElementById("username").value;

  // Get the selected service from dropdown
  var service = document.getElementById("service-dropdown").value;
  var serviceText = document.getElementById("service-dropdown").options[document.getElementById("service-dropdown").selectedIndex].text;

  // Get other form values
  var discord = document.getElementById("discord").value;
  var email = document.getElementById("email").value;
  var phone = document.getElementById("tel").value;

  // These fields may not exist until a service is selected
  var fullName = document.getElementById("full-name") ? document.getElementById("full-name").value : "";
  var addressLine1 = document.getElementById("address-line1") ? document.getElementById("address-line1").value : "";
  var addressLine2 = document.getElementById("address-line2") ? document.getElementById("address-line2").value : "";
  var city = document.getElementById("address-level2") ? document.getElementById("address-level2").value : "";
  var state = document.getElementById("address-level1") ? document.getElementById("address-level1").value : "";
  var postalCode = document.getElementById("postal-code") ? document.getElementById("postal-code").value : "";
  var country = document.getElementById("country") ? document.getElementById("country").value : "";

  // Construct key-value pairs with line breaks
  var rawData = `
===== ${serviceText} REQUEST FORM =====

BASIC INFORMATION:
-----------------------------------
Username: ${username}
Discord: ${discord}
Email: ${email}
Phone: ${phone}
`;

  // Add shipping address information if available (for 3D prints)
  if (fullName || addressLine1 || city || state || postalCode || country) {
    rawData += `
SHIPPING ADDRESS:
-----------------------------------
Full Name: ${fullName}
Street Address: ${addressLine1}
${addressLine2 ? 'Apartment/Suite/Unit: ' + addressLine2 + '\n' : ''}City: ${city}
State/Province: ${state}
Postal/ZIP Code: ${postalCode}
Country: ${country}
`;
  }

  // Add any additional form fields from the dynamic content
  var dynamicContent = document.getElementById("dynamic-content");
  if (dynamicContent) {
    // Get all section headers
    var headers = dynamicContent.querySelectorAll("h3");
    var currentSection = "";

    // Create an object to store fields by section
    var sectionData = {};

    // Process all inputs, textareas, and selects
    var allInputs = dynamicContent.querySelectorAll("input, textarea, select");

    // Group fields by their closest h3 header
    allInputs.forEach(function(input) {
      if (!input.id) return;

      // Find the closest h3 header above this input
      var header = null;
      var element = input;
      while (element && element !== dynamicContent) {
        var prevElement = element.previousElementSibling;
        while (prevElement) {
          if (prevElement.tagName === 'H3') {
            header = prevElement;
            break;
          }
          prevElement = prevElement.previousElementSibling;
        }
        if (header) break;
        element = element.parentElement;
      }

      var sectionName = header ? header.textContent : "Additional Details";

      if (!sectionData[sectionName]) {
        sectionData[sectionName] = [];
      }

      // Get the label text
      var labelText = "";
      var label = document.querySelector(`label[for="${input.id}"]`);
      if (label) {
        labelText = label.textContent.replace(':', '');
      } else {
        labelText = input.id.replace(/-/g, ' ');
      }

      // Get the value based on input type
      var value = "";

      if (input.type === 'checkbox') {
        value = input.checked ? 'Yes' : 'No';
      } else if (input.tagName === 'SELECT' && input.multiple) {
        var selectedOptions = Array.from(input.selectedOptions).map(option => option.text);
        value = selectedOptions.length > 0 ? selectedOptions.join(', ') : 'None selected';
      } else {
        value = input.value || 'Not provided';
      }

      // Add to section data
      sectionData[sectionName].push({
        label: labelText,
        value: value
      });
    });

    // Add each section to the raw data
    for (var section in sectionData) {
      if (sectionData[section].length > 0) {
        rawData += `
${section.toUpperCase()}:
-----------------------------------`;

        sectionData[section].forEach(function(field) {
          rawData += `
${field.label}: ${field.value}`;
        });

        // Add a blank line after each section
        rawData += `
`;
      }
    }
  }

  // Add timestamp
  var now = new Date();
  rawData += `
-----------------------------------
Form submitted: ${now.toLocaleString()}`;

  // Set the formatted data into the rawtext pre element
  document.getElementById("rawtext").textContent = rawData;

  return rawData;
}

function copyRaw() {
  // Get the text content directly from the pre element
  var formattedText = document.getElementById("rawtext").textContent;

  // Create a temporary textarea to copy the text
  var tempTextArea = document.createElement("textarea");
  tempTextArea.value = formattedText;
  document.body.appendChild(tempTextArea);
  tempTextArea.select();
  tempTextArea.setSelectionRange(0, 99999); /* For mobile devices */

  try {
    var successful = document.execCommand("copy");
    var msg = successful ? "Form data copied to clipboard!" : "Unable to copy form data.";
    alert(msg);
  } catch (err) {
    alert("Error copying form data: " + err);
  }

  document.body.removeChild(tempTextArea);
}

function dlraw() {
  // Get the username
  var username = document.getElementById("username").value;

  // Check if the username is empty
  if (username.trim() === "") {
    alert("Please enter a username before downloading.");
    return; // Stop further execution of the function
  }

  // Get the selected service
  var serviceDropdown = document.getElementById("service-dropdown");
  var service = serviceDropdown.value;
  var serviceText = serviceDropdown.options[serviceDropdown.selectedIndex].text;

  if (!service) {
    alert("Please select a service before downloading.");
    return;
  }

  // Get the text content directly from the pre element
  var formattedText = document.getElementById("rawtext").textContent;

  // Create a Blob containing the formatted text
  var blob = new Blob([formattedText], {
    type: "text/plain"
  });

  // Create a temporary anchor element
  var a = document.createElement("a");
  a.href = URL.createObjectURL(blob);

  // Set the file name with service type and date
  var now = new Date();
  var dateStr = now.toISOString().slice(0, 10); // YYYY-MM-DD format
  a.download = `${serviceText.toLowerCase().replace(/\s+/g, '_')}_request_${username}_${dateStr}.txt`;

  // Append the anchor to the body and trigger the click event
  document.body.appendChild(a);
  a.click();

  // Remove the anchor from the body
  document.body.removeChild(a);
}

// Function to validate service selection
function validateServiceSelection() {
  const serviceDropdown = document.getElementById('service-dropdown');
  const selected = serviceDropdown.value !== '';

  const serviceNote = document.querySelector('.service-selection-note');
  if (!selected) {
    serviceNote.style.color = '#d2691e';
    serviceNote.textContent = 'Please select a service to continue';
    return false;
  } else {
    serviceNote.style.color = '';
    serviceNote.textContent = 'Please select a service from the dropdown to continue';
    return true;
  }
}

// Add event listener to service dropdown
document.getElementById('service-dropdown').addEventListener('change', async function() {
  const service = this.value;
  const contentDiv = document.getElementById('dynamic-content');

  // Validate service selection
  validateServiceSelection();

  if (service) {
    // Load the service content
    try {
      const response = await fetch(`form/${service}.html`, { cache: 'no-store' });
      const data = await response.text();

      if (response.ok) {
        contentDiv.innerHTML = data;

        // Add onchange event to all inputs in the dynamic content
        const inputs = contentDiv.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
          input.addEventListener('change', raw);
        });

        // Call raw() to update the form data
        raw();
      } else {
        contentDiv.innerHTML = `<p>Error loading ${service} content</p>`;
      }
    } catch (error) {
      contentDiv.innerHTML = `<p>Network error: ${error.message}</p>`;
    }
  } else {
    // Clear content if no service is selected
    contentDiv.innerHTML = '';
  }
});

// Add form submission validation
document.getElementById('orderForm').addEventListener('submit', function(e) {
  if (!validateServiceSelection()) {
    e.preventDefault();
    alert('Please select a service before submitting the form.');
  }
});
</script>



        <!-- Add more input fields for other information -->

        <div class="form-preview">
          <h3>Form Preview</h3>
          <pre id="rawtext"></pre>
        </div>

        <div class="actions">
          <a href="#" aria-label="click here to download the form data as a text file" onclick="dlraw()" class="button primary">
            <span class="button-icon">ðŸ“¥</span> Download as Text File
          </a>
          <a href="#" aria-label="click here to copy the form data to clipboard" onclick="copyRaw()" class="button">
            <span class="button-icon">ðŸ“‹</span> Copy to Clipboard
          </a>
        </div>
        <br />
      </form>

     